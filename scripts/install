#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# INITIALIZE AND STORE SETTINGS
#=================================================

admin_mail=$(ynh_user_get_info --username=$admin --key="mail")

jwt_secret=$(ynh_string_random --length=32)
ynh_app_setting_set --app="$app" --key=jwt_secret --value="$jwt_secret"

#=================================================
# INSTALL ONLYOFFICE
#=================================================
ynh_script_progression --message="Install OnlyOffice Enterprise Edition..."

# Créer un répertoire sécurisé pour GPG (si nécessaire)
mkdir -p -m 700 /root/.gnupg

# Télécharger et ajouter la clé GPG OnlyOffice proprement
curl -fsSL https://download.onlyoffice.com/GPG-KEY-ONLYOFFICE | gpg --dearmor | sudo tee /usr/share/keyrings/onlyoffice.gpg > /dev/null

# Vérifier si la clé GPG est bien installée
if [ ! -f "/usr/share/keyrings/onlyoffice.gpg" ]; then
    echo "❌ Erreur : La clé GPG OnlyOffice n'a pas été installée correctement."
    exit 1
fi

# Reconfigurer le dépôt avec la clé
echo "deb [signed-by=/usr/share/keyrings/onlyoffice.gpg] https://download.onlyoffice.com/repo/debian squeeze main" | tee /etc/apt/sources.list.d/onlyoffice.list

# Activer le dépôt contrib (nécessaire pour ttf-mscorefonts-installer)
echo "deb http://deb.debian.org/debian $(lsb_release -cs) contrib" | sudo tee /etc/apt/sources.list.d/contrib.list

# Mettre à jour les dépôts UNE SEULE FOIS
apt update

# Installer les polices Microsoft requises et autres dépendances
sudo apt install -y ttf-mscorefonts-installer \
    adduser \
    imagemagick \
    libcurl4 \
    libfontconfig1 \
    libgomp1 \
    libicu-dev \
    libpng-dev \
    libstdc++6 \
    libx11-6 \
    libxext6 \
    libxml2 \
    libxslt1.1 \
    libxtst6 \
    nginx-extras \
    postgresql \
    postgresql-contrib \
    rabbitmq-server \
    redis-server \
    unzip \
    xfonts-75dpi \
    xfonts-base

# Vérifier si l'installation des paquets a réussi
if [ $? -ne 0 ]; then
    echo "❌ Erreur : L'installation des dépendances a échoué."
    exit 1
fi

# Installer OnlyOffice DocumentServer Enterprise Edition
apt install -y onlyoffice-documentserver-ee

# Vérifier si l'installation a réussi
if [ $? -ne 0 ]; then
    echo "❌ Erreur : L'installation de OnlyOffice DocumentServer EE a échoué."
    exit 1
fi

#=================================================
# ADD A CONFIGURATION
#=================================================
ynh_script_progression --message="Adding $app's configuration file..."

ynh_replace_string --target_file="/etc/onlyoffice/documentserver/default.json" \
    --match_string="\"rejectUnauthorized\": true" \
    --replace_string="\"rejectUnauthorized\": false" 
ynh_store_file_checksum --file="/etc/onlyoffice/documentserver/default.json"

#=================================================
# INSTALL LICENSE
#=================================================
ynh_script_progression --message="Installing Enterprise Edition license..."

# Copie du fichier de licence s'il existe
if [ -f "../conf/license.lic" ]; then
    ynh_script_progression --message="Installing license file..."
    cp ../conf/license.lic /var/www/onlyoffice/Data/license.lic
    chown onlyoffice:onlyoffice /var/www/onlyoffice/Data/license.lic
fi

#=================================================
# REGENERATE FONTS
#=================================================
ynh_script_progression --message="Generating fonts..."

/usr/bin/documentserver-generate-allfonts.sh 2>/dev/null

#=================================================
# SECURE FILES AND DIRECTORIES
#=================================================

# Set permissions to app files
chmod 750 "$install_dir"
chmod -R o-rwx "$install_dir"
chown -R onlyoffice:onlyoffice "$install_dir"

#=================================================
# ADVERTISE SERVICE IN ADMIN PANEL
#=================================================

for service in "ds-converter" "ds-docservice" "ds-metrics"; do
    yunohost service add "$service"
done

#=================================================
# START SERVICES
#=================================================

for service in "ds-converter" "ds-docservice" "ds-metrics"; do
    ynh_systemd_action --action=restart --service_name="$service"
done

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_script_progression --message="Configuring NGINX web server..."

# Create a dedicated NGINX config
ynh_add_nginx_config

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Installation of $app completed"
